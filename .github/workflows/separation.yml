name: Builder/Tester Separation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check-separation:
    name: Verify builder/tester separation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check no commit mixes src/ and tests/
        run: |
          FAILED=0

          # For PRs, check commits in the PR. For pushes, check the pushed commits.
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, check commits in the push
            BASE="${{ github.event.before }}"
            HEAD="${{ github.event.after }}"
          fi

          # Skip if this is the initial push (no before SHA)
          if [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
            echo "Initial push — skipping separation check."
            exit 0
          fi

          for COMMIT in $(git rev-list "$BASE".."$HEAD"); do
            AUTHOR=$(git log -1 --format='%ae' "$COMMIT")
            FILES=$(git diff-tree --no-commit-id --name-only -r "$COMMIT")

            TOUCHES_SRC=$(echo "$FILES" | grep -c '^src/' || true)
            TOUCHES_TESTS=$(echo "$FILES" | grep -c '^tests/' || true)

            if [ "$TOUCHES_SRC" -gt 0 ] && [ "$TOUCHES_TESTS" -gt 0 ]; then
              SHORT=$(git rev-parse --short "$COMMIT")
              echo "::error::Commit $SHORT ($AUTHOR) modifies both src/ and tests/ — violates builder/tester separation"
              echo "  Source files:"
              echo "$FILES" | grep '^src/' | sed 's/^/    /'
              echo "  Test files:"
              echo "$FILES" | grep '^tests/' | sed 's/^/    /'
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "Builder/tester separation requires that code and tests be authored"
            echo "in separate commits by different agents. A builder who can change"
            echo "tests to match broken code will do so."
            exit 1
          fi

          echo "All commits respect builder/tester separation."

  tests:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        run: uv run pytest tests/ -v
